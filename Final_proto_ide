#include <Wire.h>
#include <SensirionI2cSht4x.h>

#define TCA_ADDR 0x70  // TCA9548A default I2C address
#define SHT_ADDR 0x44  // SHT4x default I2C address

SensirionI2cSht4x shtSensor; // reuse same instance

// Switch TCA9548A channel (0..7)
void tcaSelect(uint8_t channel) {
  if (channel > 7) return;
  Wire.beginTransmission(TCA_ADDR);
  Wire.write(1 << channel);   // enable specific channel
  Wire.endTransmission();
}

void setup() {
  Serial.begin(115200);
  Wire.begin();
  
  // Quick init on channel 0
  tcaSelect(0);
  shtSensor.begin(Wire, SHT_ADDR);
  shtSensor.softReset();
  delay(50);
  
  Serial.println("SHT45 ready");
}

void loop() {
  float temperature = 0.0f, humidity = 0.0f;
  int16_t error;

  // Read sensor on channel 0
  tcaSelect(0);
  shtSensor.begin(Wire, SHT_ADDR);
  error = shtSensor.measureHighPrecision(temperature, humidity);
  
  // Output CSV format: "28.10,64.5"
  if (error == 0) {
    Serial.print(temperature, 2);
    Serial.print(",");
    Serial.println(humidity, 1);
  } else {
    Serial.println("ERROR,-1");
  }
  
  delay(1000);  // ~2.8Hz sampling matching terminal
}
